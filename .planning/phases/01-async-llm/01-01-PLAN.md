---
phase: 01-async-llm
plan: 01
type: execute
---

<objective>
비동기 LLM 호출 인프라 구축

Purpose: LLM API 호출을 비동기로 처리하여 GUI가 멈추지 않도록 하는 기반 코드 작성
Output: AsyncLLMWrapper 클래스, ProgressDialog 컴포넌트, ContentGenerator 비동기 메서드
</objective>

<execution_context>
~/.claude/get-shit-done/workflows/execute-phase.md
./summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/codebase/ARCHITECTURE.md
@.planning/codebase/CONVENTIONS.md

**핵심 소스 파일:**
@services/llm_service.py
@services/content_generator.py
@gui/tabs/scenes_tab.py (threading 패턴 참고)

**결정사항:**
- threading 사용 (asyncio 대신) - tkinter와 통합 용이
- 콜백 기반 결과 처리
</context>

<tasks>

<task type="auto">
  <name>Task 1: AsyncLLMWrapper 클래스 생성</name>
  <files>services/async_llm_wrapper.py</files>
  <action>
threading.Thread를 사용한 비동기 LLM 호출 래퍼 클래스 생성:

```python
class AsyncLLMWrapper:
    def __init__(self, llm_service):
        self.llm = llm_service
        self._current_thread = None
        self._cancelled = False

    def call_async(self, prompt, system_prompt=None,
                   on_success=None, on_error=None, on_progress=None):
        """비동기 LLM 호출"""
        # threading.Thread로 백그라운드 실행
        # 결과는 콜백으로 전달

    def cancel(self):
        """현재 작업 취소 플래그 설정"""
        self._cancelled = True

    def is_running(self):
        """작업 진행 중 여부"""
```

주의사항:
- 콜백은 반드시 메인 스레드에서 실행되도록 할 것 (tkinter 안전성)
- 취소 플래그 체크 후 콜백 호출
- 예외 처리를 on_error 콜백으로 전달
  </action>
  <verify>python -c "from services.async_llm_wrapper import AsyncLLMWrapper; print('Import OK')"</verify>
  <done>AsyncLLMWrapper 클래스가 생성되고 import 가능</done>
</task>

<task type="auto">
  <name>Task 2: ProgressDialog 컴포넌트 생성</name>
  <files>gui/dialogs/progress_dialog.py</files>
  <action>
LLM 호출 중 표시할 진행 상태 다이얼로그 생성:

```python
class ProgressDialog:
    def __init__(self, parent, title="처리 중...", message="잠시만 기다려주세요."):
        self.dialog = tk.Toplevel(parent)
        # 모달 설정
        # 취소 버튼 (선택적)
        # 상태 메시지 레이블
        # 프로그레스 바 (indeterminate mode)

    def update_message(self, message):
        """상태 메시지 업데이트"""

    def close(self):
        """다이얼로그 닫기"""

    def set_cancel_callback(self, callback):
        """취소 버튼 콜백 설정"""
```

주의사항:
- 한국어 UI 유지
- 부모 윈도우 중앙에 위치
- 닫기 버튼(X) 클릭 시 취소 콜백 호출
- grab_set()으로 모달 처리
  </action>
  <verify>python -c "from gui.dialogs.progress_dialog import ProgressDialog; print('Import OK')"</verify>
  <done>ProgressDialog 클래스가 생성되고 import 가능</done>
</task>

<task type="auto">
  <name>Task 3: ContentGenerator 비동기 메서드 추가</name>
  <files>services/content_generator.py</files>
  <action>
ContentGenerator에 비동기 버전 메서드 추가:

1. `__init__`에 AsyncLLMWrapper 인스턴스 추가
2. 각 생성 메서드의 비동기 버전 추가:
   - `generate_character_profile_async(synopsis, char_name, char_info, on_success, on_error)`
   - `generate_script_async(chapter, synopsis, characters_info, previous_script, on_success, on_error)`
   - `generate_scenes_async(chapter, synopsis, characters_info, character_prompts_info, on_success, on_error)`
   - `generate_image_prompts_async(character, synopsis, visual_age, on_success, on_error)`

패턴:
```python
def generate_script_async(self, chapter, synopsis, characters_info, previous_script="",
                          on_success=None, on_error=None):
    """비동기 대본 생성"""
    def _do_generate():
        try:
            result = self.generate_script(chapter, synopsis, characters_info, previous_script)
            return result
        except Exception as e:
            raise e

    self.async_llm.call_async(
        task_func=_do_generate,
        on_success=on_success,
        on_error=on_error
    )
```

주의사항:
- 기존 동기 메서드는 유지 (하위 호환성)
- 비동기 메서드는 _async 접미사 사용
- on_success 콜백에 결과 전달
- on_error 콜백에 예외 전달
  </action>
  <verify>python -c "from services.content_generator import ContentGenerator; print('Import OK')"</verify>
  <done>ContentGenerator에 비동기 메서드 4개 추가됨</done>
</task>

</tasks>

<verification>
완료 전 확인사항:
- [ ] services/async_llm_wrapper.py 생성됨
- [ ] gui/dialogs/progress_dialog.py 생성됨
- [ ] content_generator.py에 async 메서드 추가됨
- [ ] 모든 파일 import 성공
- [ ] 기존 코드 깨지지 않음 (python main.py 실행 확인)
</verification>

<success_criteria>
- AsyncLLMWrapper 클래스 생성 완료
- ProgressDialog 컴포넌트 생성 완료
- ContentGenerator에 4개 async 메서드 추가
- 기존 동기 메서드 하위 호환성 유지
- 모든 import 정상 작동
</success_criteria>

<output>
완료 후 `.planning/phases/01-async-llm/01-01-SUMMARY.md` 생성:

# Phase 1 Plan 1: Async Infrastructure Summary

**비동기 LLM 호출 인프라 구축 완료**

## Accomplishments
- AsyncLLMWrapper 클래스 생성
- ProgressDialog 컴포넌트 생성
- ContentGenerator async 메서드 추가

## Files Created/Modified
- `services/async_llm_wrapper.py` - 신규
- `gui/dialogs/progress_dialog.py` - 신규
- `services/content_generator.py` - 수정

## Decisions Made
[실행 중 결정사항]

## Issues Encountered
[문제 및 해결방법]

## Next Step
Ready for 01-02-PLAN.md (탭 업데이트)
</output>
